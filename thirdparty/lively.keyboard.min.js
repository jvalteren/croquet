!function(){!function(e,n,t){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define(n,t):e[n]=t()}(this,"bowser",function(){function e(e){function n(n){var t=e.match(n);return t&&t.length>1&&t[1]||""}var t,o=n(/(ipod|iphone|ipad)/i).toLowerCase(),i=/like android/i.test(e),r=!i&&/android/i.test(e),s=/nexus\s*[0-6]\s*/i.test(e),u=!s&&/nexus\s*[0-9]+/i.test(e),c=/CrOS/.test(e),d=/silk/i.test(e),l=/sailfish/i.test(e),m=/tizen/i.test(e),p=/(web|hpw)os/i.test(e),f=/windows phone/i.test(e),h=(/SamsungBrowser/i.test(e),!f&&/windows/i.test(e)),y=!o&&!d&&/macintosh/i.test(e),v=!r&&!l&&!m&&!p&&/linux/i.test(e),b=n(/edge\/(\d+(\.\d+)?)/i),k=n(/version\/(\d+(\.\d+)?)/i),g=/tablet/i.test(e),w=!g&&/[^-]mobi/i.test(e),x=/xbox/i.test(e);/opera/i.test(e)?t={name:"Opera",opera:a,version:k||n(/(?:opera|opr|opios)[\s\/](\d+(\.\d+)?)/i)}:/opr|opios/i.test(e)?t={name:"Opera",opera:a,version:n(/(?:opr|opios)[\s\/](\d+(\.\d+)?)/i)||k}:/SamsungBrowser/i.test(e)?t={name:"Samsung Internet for Android",samsungBrowser:a,version:k||n(/(?:SamsungBrowser)[\s\/](\d+(\.\d+)?)/i)}:/coast/i.test(e)?t={name:"Opera Coast",coast:a,version:k||n(/(?:coast)[\s\/](\d+(\.\d+)?)/i)}:/yabrowser/i.test(e)?t={name:"Yandex Browser",yandexbrowser:a,version:k||n(/(?:yabrowser)[\s\/](\d+(\.\d+)?)/i)}:/ucbrowser/i.test(e)?t={name:"UC Browser",ucbrowser:a,version:n(/(?:ucbrowser)[\s\/](\d+(?:\.\d+)+)/i)}:/mxios/i.test(e)?t={name:"Maxthon",maxthon:a,version:n(/(?:mxios)[\s\/](\d+(?:\.\d+)+)/i)}:/epiphany/i.test(e)?t={name:"Epiphany",epiphany:a,version:n(/(?:epiphany)[\s\/](\d+(?:\.\d+)+)/i)}:/puffin/i.test(e)?t={name:"Puffin",puffin:a,version:n(/(?:puffin)[\s\/](\d+(?:\.\d+)?)/i)}:/sleipnir/i.test(e)?t={name:"Sleipnir",sleipnir:a,version:n(/(?:sleipnir)[\s\/](\d+(?:\.\d+)+)/i)}:/k-meleon/i.test(e)?t={name:"K-Meleon",kMeleon:a,version:n(/(?:k-meleon)[\s\/](\d+(?:\.\d+)+)/i)}:f?(t={name:"Windows Phone",windowsphone:a},b?(t.msedge=a,t.version=b):(t.msie=a,t.version=n(/iemobile\/(\d+(\.\d+)?)/i))):/msie|trident/i.test(e)?t={name:"Internet Explorer",msie:a,version:n(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:c?t={name:"Chrome",chromeos:a,chromeBook:a,chrome:a,version:n(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:/chrome.+? edge/i.test(e)?t={name:"Microsoft Edge",msedge:a,version:b}:/vivaldi/i.test(e)?t={name:"Vivaldi",vivaldi:a,version:n(/vivaldi\/(\d+(\.\d+)?)/i)||k}:l?t={name:"Sailfish",sailfish:a,version:n(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(e)?t={name:"SeaMonkey",seamonkey:a,version:n(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel|fxios/i.test(e)?(t={name:"Firefox",firefox:a,version:n(/(?:firefox|iceweasel|fxios)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(e)&&(t.firefoxos=a)):d?t={name:"Amazon Silk",silk:a,version:n(/silk\/(\d+(\.\d+)?)/i)}:/phantom/i.test(e)?t={name:"PhantomJS",phantom:a,version:n(/phantomjs\/(\d+(\.\d+)?)/i)}:/slimerjs/i.test(e)?t={name:"SlimerJS",slimer:a,version:n(/slimerjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(e)||/rim\stablet/i.test(e)?t={name:"BlackBerry",blackberry:a,version:k||n(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:p?(t={name:"WebOS",webos:a,version:k||n(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(e)&&(t.touchpad=a)):/bada/i.test(e)?t={name:"Bada",bada:a,version:n(/dolfin\/(\d+(\.\d+)?)/i)}:m?t={name:"Tizen",tizen:a,version:n(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||k}:/qupzilla/i.test(e)?t={name:"QupZilla",qupzilla:a,version:n(/(?:qupzilla)[\s\/](\d+(?:\.\d+)+)/i)||k}:/chromium/i.test(e)?t={name:"Chromium",chromium:a,version:n(/(?:chromium)[\s\/](\d+(?:\.\d+)?)/i)||k}:/chrome|crios|crmo/i.test(e)?t={name:"Chrome",chrome:a,version:n(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:r?t={name:"Android",version:k}:/safari|applewebkit/i.test(e)?(t={name:"Safari",safari:a},k&&(t.version=k)):o?(t={name:"iphone"==o?"iPhone":"ipad"==o?"iPad":"iPod"},k&&(t.version=k)):t=/googlebot/i.test(e)?{name:"Googlebot",googlebot:a,version:n(/googlebot\/(\d+(\.\d+))/i)||k}:{name:n(/^(.*)\/(.*) /),version:function(n){var t=e.match(n);return t&&t.length>1&&t[2]||""}(/^(.*)\/(.*) /)},!t.msedge&&/(apple)?webkit/i.test(e)?(/(apple)?webkit\/537\.36/i.test(e)?(t.name=t.name||"Blink",t.blink=a):(t.name=t.name||"Webkit",t.webkit=a),!t.version&&k&&(t.version=k)):!t.opera&&/gecko\//i.test(e)&&(t.name=t.name||"Gecko",t.gecko=a,t.version=t.version||n(/gecko\/(\d+(\.\d+)?)/i)),t.windowsphone||t.msedge||!r&&!t.silk?t.windowsphone||t.msedge||!o?y?t.mac=a:x?t.xbox=a:h?t.windows=a:v&&(t.linux=a):(t[o]=a,t.ios=a):t.android=a;var C="";t.windowsphone?C=n(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):o?(C=n(/os (\d+([_\s]\d+)*) like mac os x/i),C=C.replace(/[_\s]/g,".")):r?C=n(/android[ \/-](\d+(\.\d+)*)/i):t.webos?C=n(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):t.blackberry?C=n(/rim\stablet\sos\s(\d+(\.\d+)*)/i):t.bada?C=n(/bada\/(\d+(\.\d+)*)/i):t.tizen&&(C=n(/tizen[\/\s](\d+(\.\d+)*)/i)),C&&(t.osversion=C);var S=C.split(".")[0];return g||u||"ipad"==o||r&&(3==S||S>=4&&!w)||t.silk?t.tablet=a:(w||"iphone"==o||"ipod"==o||r||s||t.blackberry||t.webos||t.bada)&&(t.mobile=a),t.msedge||t.msie&&t.version>=10||t.yandexbrowser&&t.version>=15||t.vivaldi&&t.version>=1||t.chrome&&t.version>=20||t.samsungBrowser&&t.version>=4||t.firefox&&t.version>=20||t.safari&&t.version>=6||t.opera&&t.version>=10||t.ios&&t.osversion&&t.osversion.split(".")[0]>=6||t.blackberry&&t.version>=10.1||t.chromium&&t.version>=20?t.a=a:t.msie&&t.version<10||t.chrome&&t.version<20||t.firefox&&t.version<20||t.safari&&t.version<6||t.opera&&t.version<10||t.ios&&t.osversion&&t.osversion.split(".")[0]<6||t.chromium&&t.version<20?t.c=a:t.x=a,t}function n(e){return e.split(".").length}function t(e,n){var t,o=[];if(Array.prototype.map)return Array.prototype.map.call(e,n);for(t=0;t<e.length;t++)o.push(n(e[t]));return o}function o(e){for(var o=Math.max(n(e[0]),n(e[1])),i=t(e,function(e){var i=o-n(e);return e+=new Array(i+1).join(".0"),t(e.split("."),function(e){return new Array(20-e.length).join("0")+e}).reverse()});--o>=0;){if(i[0][o]>i[1][o])return 1;if(i[0][o]!==i[1][o])return-1;if(0===o)return 0}}function i(n,t,i){var r=s;"string"==typeof t&&(i=t,t=void 0),void 0===t&&(t=!1),i&&(r=e(i));var a=""+r.version;for(var u in n)if(n.hasOwnProperty(u)&&r[u]){if("string"!=typeof n[u])throw new Error("Browser version in the minVersion map should be a string: "+u+": "+String(n));return o([a,n[u]])<0}return t}function r(e,n,t){return!i(e,n,t)}var a=!0,s=e("undefined"!=typeof navigator?navigator.userAgent||"":"");return s.test=function(e){for(var n=0;n<e.length;++n){var t=e[n];if("string"==typeof t&&t in s)return!0}return!1},s.isUnsupportedBrowser=i,s.compareVersions=o,s.check=r,s._detect=e,s});var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;this.lively=this.lively||{},function(e,n,t){"use strict";function o(e){return n.obj.inspect(e,{maxDepth:1}).replace(/\n/g,"").replace(/\s+/g," ")}function i(e){var n=e.key,t=e.ctrlKey,o=e.altKey,i=e.shiftKey,r=e.metaKey,s=0|(t?1:0)|(o?2:0)|(i?4:0)|(r?8:0);return 0===s&&!a(n)&&n&&C.test(n)&&(s=-1),s}function r(e){return!K(e)&&(e=e.replace(/-$/,"").toLowerCase(),n.arr.withoutAll(Object.keys(S),["","input-"]).includes(e))}function a(e){switch(e=e.toLowerCase()){case"space":e="space";break;case"esc":e="escape";break;case"return":e="enter";break;case"arrowleft":e="left";break;case"arrowright":e="right";break;case"arrowup":e="up";break;case"arrowdown":e="down";break;case"esc":e="escape";break;case"return":e="enter"}return E.includes(e)?n.string.capitalize(e):""}function s(e,n){var t=e,o=function(e,n){return String.fromCharCode(parseInt(n,16))},i=t&&t.replace(/u\+?([\d\w]{4})/gi,o);return"Command"!==i&&"Cmd"!==i||(i="Meta")," "===i&&(i="Space"),8===n&&(i="Backspace"),i}function u(e){var n=e.code;if("string"!=typeof n)return null;if(n.startsWith("Key"))return n.slice(3);if(n.startsWith("Numpad"))return n;if(n.startsWith("Digit"))return n.slice(5);if(n.startsWith("Arrow"))return n.slice(5);if(n.match(/^F[0-9]{1-2}$/))return n;switch(n){case"Insert":case"Home":case"PageUp":case"PageDown":return n;case"Period":return".";case"Comma":return",";case"Help":return"Insert";case"Equal":return"=";case"Backslash":case"IntlBackslash":return"\\";case"Equal":return"=";case"Minus":return"-";case"BracketRight":return"]";case"BracketLeft":return"[";case"Quote":return"'";case"Backquote":return"`";case"Semicolon":return";"}return null}function c(e){for(var n=[];;){var t=e.indexOf("-");if(-1===t)return e&&n.push(e),n;0===t?(n.push(e[0]),e=e.slice(2)):(n.push(e.slice(0,t)),e=e.slice(t+1))}}function d(e){return e.length?e:" "}function l(e,n){var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];n=B.canonicalizeEvent(n);var o=n,i=o.keyCombo,r=o.key,a=o.data,s=void 0,u=!1,c=e.keyhandlers,d=n.keyInputState||{},l=i.startsWith("input-"),m=!1,p=d.count,f=d.keyChain||"",h=!1;if(!c||t&&l)return!1;for(var y=c.length;y--;)if((s=c[y].eventCommandLookup(e,n))&&s.command){var v=s,b=v.command,k=v.args,g=v.passEvent,w=v.count,x=v.keyChain,C=v.onlyWhenFocused;if(h=!0,p=w,f=x,m="null"===b,C){var S=e.world();if(S&&S.focusedMorph&&S.focusedMorph!==e)continue}if(u=!m&&e.execCommand(b,k,w,n),!u||l&&"insertstring"===b||g||"function"!=typeof n.stop||n.stop(),u||m)break}if(!u&&!m&&l&&e.onTextInput&&!f){var K=d.count;u=e.execCommand("insertstring",{string:a||r,undoGroup:600},K,n)}return h&&("function"==typeof n.onAfterDispatch?n.onAfterDispatch(function(){d.count=u?void 0:p,d.keyChain=u?"":f}):(d.count=u?void 0:p,d.keyChain=u?"":f)),u&&!m}function m(e,n,t){return l(e,g({},B.keyComboToEventSpec(n),{keyInputState:t}))}function p(){return t.mac?"mac":t.windows?"windows":t.windowsphone?"windowsphone":t.linux?"linux":t.chromeos?"chromeos":t.android?"android":t.ios?"ios":t.blackberry?"blackberry":t.firefoxos?"firefoxos":t.webos?"webos":t.bada?"bada":t.tizen?"tizen":t.sailfish?"sailfish":"unknown"}function f(e,n){if("string"==typeof e)return e;if(!e||"object"!==(void 0===e?"undefined":h(e)))return null;switch(n){case"ios":return e.ios||e.mac;case"mac":return e.mac||e.ios;case"win":case"windows":case"windowsphone":return e.win||e.windows;case"linux":return e.linux||e.win||e.windows;case"chromeos":return e.chromeos||e.linux||e.win||e.windows;case"android":return e.android||e.linux||e.win||e.windows;default:return e.linux||e.win||e.windows}}t="default"in t?t.default:t;var h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y=function(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,t){function o(i,r){try{var a=n[i](r),s=a.value}catch(e){return void t(e)}if(!a.done)return Promise.resolve(s).then(function(e){o("next",e)},function(e){o("throw",e)});e(s)}return o("next")})}},v=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},b=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),k=function(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e},g=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},w=function(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)},x=function(){function e(){v(this,e),this.history=[],this.maxHistorySize=300}return b(e,[{key:"addToHistory",value:function(e){this.history.push(e),this.history.length>this.maxHistorySize&&this.history.splice(0,this.history.length-this.maxHistorySize)}},{key:"printHistory",value:function(){return this.history.map(function(e){var n=e.name,t=e.target.string,i=e.args,r=e.count;return n+" "+(i?o(i):"")+("number"==typeof r?" x"+r:"")+" "+t}).join("\n")}},{key:"lookupCommand",value:function(e,n){var t,o;return e?("string"==typeof e&&(t=e),"string"==typeof e.command&&(t=e.command),e.exec&&(o=e,t=o.name),o||(o=n.commands.find(function(e){return e.name===t})),{name:t,command:o}):{}}},{key:"exec",value:function(e,n,t,o,i){var r=this,a=this.lookupCommand(e,n)||{},s=a.name,u=a.command;if(!u)return console.warn("Cannot find command "+(s||e)),null;s&&this.addToHistory({name:s,target:{string:String(n),id:n.id},args:t,count:o,time:Date.now()});var c,d=n.world();if("function"==typeof u.exec)try{c=u.exec(n,t,u.handlesCount?o:void 0,i)}catch(e){c=e;var l="Error in interactive command "+s+": "+(e.stack||e);d?d.logError(l):console.error(l)}else console.error("command "+s+" has no exec function!");return c&&"function"==typeof c.catch&&c.catch(function(e){var n="Error in interactive command "+s+": "+e+"\n"+(e.stack||e);throw d?d.logError(n):console.error(n),e}),c&&"number"==typeof o&&o>1&&!u.handlesCount&&(c="function"==typeof c.then?c.then(function(){return r.exec(u,n,t,o-1,i,null)}):this.exec(u,n,t,o-1,i,null)),c}}]),e}(),C=/[a-z]/i,S=function(){for(var e={control:1,ctrl:1,alt:2,option:2,shift:4,super:8,win:8,meta:8,command:8,cmd:8},n=["alt","ctrl","meta","shift"],t=Math.pow(2,n.length);t--;)e[t]=n.filter(function(n){return t&e[n]}).join("-")+"-";return e[0]="",e[-1]="input-",e}(),K=function(){var e=/^[0-9]+$/;return function(n){return e.test(n)}}(),E=["backspace","tab","enter","pause","escape"," ","pageup","pagedown","end","home","left","up","right","down","print","insert","delete","numpad0","numpad1","numpad2","numpad3","numpad4","numpad5","numpad6","numpad7","numpad8","numpad9","numpadenter","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","numlock","scrolllock"],B={computeHashIdOfEvent:i,keyComboToEventSpec:function(e,t){var o=g({_isLivelyKeyEventSpec:!0,keyCombo:"",key:"",ctrlKey:!1,shiftKey:!1,altKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1},t),i=c(e),r={shift:"shiftKey",control:"ctrlKey",ctrl:"ctrlKey",alt:"altKey",meta:"metaKey",command:"metaKey",cmd:"metaKey"};if("input"===i[0]&&2===i.length)return o.keyCombo=e,o.key=i[1],o;for(var s=i.length-1;s>=0;s--){var u=i[s],d=r[u.toLowerCase()];d&&(i.splice(s,1),o.isModified=!0,o[d]=!0)}if(!i.length)return o.keyCombo=B.eventToKeyCombo(o),o.key=n.arr.last(c(o.keyCombo)),o.onlyModifiers=!0,o;i.length>1&&console.warn('Strange key "'+e+'" encountered in keyComboToEventSpec, parsing probably failed');var l=n.arr.last(i),m=a(l);return m?(o.isFunctionKey=!0,o.key=m):o.isModified?o.key=n.string.capitalize(l):o.key=l,o.keyCombo=B.eventToKeyCombo(o),o},eventToKeyCombo:function(e,t){var o=g({ignoreModifiersIfNoCombo:!1,ignoreKeys:[]},t),a=(o.ignoreModifiersIfNoCombo,o.ignoreKeys,e.key),c=e.data,d=e.keyIdentifier;if("string"==typeof c)return"input-"+c;if(!a&&d&&(a=s(d,e.which||e.keyCode),e.key=a=a[e.shiftKey?"toUpperCase":"toLowerCase"](),r(a)))return n.string.capitalize(a);var l=S[i(e)];if("input-"===l)return l+a;e.code&&(a=u(e)||a);var m=!a||r(a)?l.replace(/-$/,""):l+a;return m.match(/\s$/)&&(m=m.replace(/\s$/,"Space")),m.replace(/(^|-)([a-z])/g,function(e,n,t){return n+t.toUpperCase()})},canonicalizeKeyCombo:function(e){return B.eventToKeyCombo(B.keyComboToEventSpec(e))},canonicalizeEvent:function(e){return e._isLivelyKeyEventSpec?e:B.keyComboToEventSpec(B.eventToKeyCombo(e))}},T=function(){var e=y(regeneratorRuntime.mark(function e(n,t){var o,i,r,a,s,u,c,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{keyChain:void 0,count:void 0};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o=1===t.length?[t]:t.split(/ /g).map(d),i=!0,r=!1,a=void 0,e.prev=4,s=o[Symbol.iterator]();case 6:if(i=(u=s.next()).done){e.next=13;break}return c=u.value,e.next=10,m(n,c,l);case 10:i=!0,e.next=6;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(4),r=!0,a=e.t0;case 19:e.prev=19,e.prev=20,!i&&s.return&&s.return();case 22:if(e.prev=22,!r){e.next=25;break}throw a;case 25:return e.finish(22);case 26:return e.finish(19);case 27:case"end":return e.stop()}},e,this,[[4,15,19,27],[20,,22,26]])}));return function(n,t){return e.apply(this,arguments)}}(),O={meta:/Meta|Cmd|Command/gi,alt:/Alt/gi,ctrl:/Ctrl|Control/gi,tab:/Tab/gi,enter:/Enter|Return/gi,shift:/Shift/gi,backspace:/Backspace/gi,delete:/del(ete)?/gi,left:/left/gi,right:/right/gi,up:/up/gi,down:/down/gi,keySpacer:/([^-])-/g,seqSpacer:/([^\s])\s/g},D=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:p();v(this,e),this.platform=n,this.keyBindings={}}return b(e,null,[{key:"invokeKeyHandlers",value:function(e,n){return l(e,n,arguments.length>2&&void 0!==arguments[2]&&arguments[2])}},{key:"simulateKeys",value:function(e,n,t){return T(e,n,t)}},{key:"withBindings",value:function(e,n){var t=new this(n);return e.forEach(function(e){var n=e.command,o=e.keys;return t.bindKey(o,n)}),t}},{key:"prettyCombo",value:function(e){var n=this._prettyCombos||(this._prettyCombos={});return this._prettyCombos[e]?n[e]:n[e]=e.replace(O.meta,"⌘").replace(O.alt,"⌥").replace(O.ctrl,"⌃").replace(O.tab,"⇥").replace(O.enter,"⏎").replace(O.shift,"⇧").replace(O.backspace,"⌫").replace(O.delete,"⌦").replace(O.left,"→").replace(O.right,"←").replace(O.up,"↑").replace(O.down,"↓").replace(O.keySpacer,"$1").replace(O.seqSpacer,"$1-")}},{key:"generateCommandToKeybindingMap",value:function(e){function t(e){if(s[e.id])return s[e.id];var t=a[e.id]||(a[e.id]=e.keyCommandMap);return s[e.id]=n.arr.groupBy(Object.keys(t),function(e){return t[e].name})}var o=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a={},s={};return(i?e.commandsIncludingOwners||[]:e.commands.map(function(n){return{command:n,target:e}})).map(function(e){var n=e.target,i=e.command,a=t(n)[i.name];return{keys:a,target:n,command:i,prettyKeys:a&&r?a.map(function(e){return o.prettyCombo(e)}):null}})}}]),b(e,[{key:"eventCommandLookup",value:function(e,n){var t=n.keyCombo,o=n.keyInputState;return this.lookup(t,o)}},{key:"lookup",value:function(e){var t=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{keyChain:void 0,count:void 0};e=B.canonicalizeKeyCombo(e);var i=o.keyChain||"",r=o.count;if(!i&&e.startsWith("Ctrl-")){var a=e.match(/^Ctrl-([0-9]+)/);if(a){return{command:"null",count:parseInt(("number"==typeof r?r:"")+a[1])}}if("Ctrl-U"===e)return{command:"null",count:4,keyChain:"Ctrl-U"}}var s=[e];if(!d&&e.startsWith("input-")){var u=e.replace(/^(input-)(.*)$/,function(e,n,t){return n+t.toUpperCase()}),c=e.replace(/^(input-)(.*)$/,function(e,n,t){return n+t.toLowerCase()});s.includes(u)||s.push(u),s.includes(c)||s.push(c)}var d=n.arr.findAndGet(s,function(e){return t.keyBindings[e]});if(i){var l=s.find(function(e){return t.keyBindings[i+" "+e]});l&&(i+=" "+l,d=this.keyBindings[i]||d)}if(d&&"chainKeys"===d){i=i||e;var m={command:"null",keyChain:i};return void 0!==r&&(m.count=r),m}if(d){var m="object"===(void 0===d?"undefined":h(d))?g({},d):{command:d};return void 0!==r&&(m.count=r),m}}},{key:"bindKey",value:function(e,n){var t=this;if("object"==(void 0===e?"undefined":h(e))&&e&&!Array.isArray(e)&&(e=f(e,this.platform)),e){if("function"==typeof n)return this.addCommand({exec:n,bindKey:e,name:n.name||e});(Array.isArray(e)?e:e.includes("|")?e.split("|"):[e]).forEach(function(e){var o="";if(-1!=e.indexOf(" ")){var i=e.split(/\s+/);e=i.pop(),i.forEach(function(e){var n=B.canonicalizeKeyCombo(e);o+=(o?" ":"")+n,t.addCommandToBinding(o,"chainKeys")}),o+=" "}t.addCommandToBinding(o+B.canonicalizeKeyCombo(e),n)}),this.cleanupUnusedKeyChains()}}},{key:"unbindKey",value:function(e){this.bindKey(e,null)}},{key:"cleanupUnusedKeyChains",value:function(){var e=this,t=Object.keys(this.keyBindings),o=t.filter(function(n){return"chainKeys"===e.keyBindings[n]});o=n.arr.sortBy(o,function(e){return e.length}).reverse(),o.forEach(function(i){t.some(function(e){return i!==e&&e.startsWith(i)})||(delete e.keyBindings[i],n.arr.remove(t,i),n.arr.remove(o,i))})}},{key:"addCommand",value:function(e){return e&&e.bindKey?this.addCommandToBinding(e.bindKey,e):void 0}},{key:"addCommandToBinding",value:function(e,n){var t=this;"chainKeys"===this.keyBindings[e]&&"chainKeys"!=n&&Object.keys(this.keyBindings).forEach(function(n){n.startsWith(e)&&delete t.keyBindings[n]}),n?this.keyBindings[e]=n:delete this.keyBindings[e],"chainKeys"!==n&&this.cleanupUnusedKeyChains()}}]),e}(),j=new RegExp("","g"),N=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};v(this,e),this.eventDispatcher=n,this.keepTextNodeFocused=!!t.hasOwnProperty("keepTextNodeFocused")&&t.keepTextNodeFocused,this.domState={rootNode:null,textareaNode:null,eventHandlers:[],isInstalled:!1},this.inputState={composition:null,manualCopy:null,manualPaste:null}}return b(e,[{key:"install",value:function(e){var n=this,o=this.domState,i="undefined"!=typeof window&&e===window?window.document:e.ownerDocument,r=o.isInstalled,a=o.rootNode;if(r){if(a===e)return;this.uninstall()}o.isInstalled=!0,o.rootNode=e,e.tabIndex=1;var s=o.textareaNode=i.createElement("textarea");return s.setAttribute("style","\n      position: absolute;\n      /*extent cannot be 0, input won't work correctly in Chrome 52.0*/\n      width: 20px; height: 20px;\n      z-index: 0;\n      opacity: 0;\n      background: transparent;\n      -moz-appearance: none;\n      appearance: none;\n      border: none;\n      resize: none;\n      outline: none;\n      overflow: hidden;\n      font: inherit;\n      padding: 0 1px;\n      margin: 0 -1px;\n      text-indent: -1em;\n      -ms-user-select: text;\n      -moz-user-select: text;\n      -webkit-user-select: text;\n      user-select: text;\n      /*with pre-line chrome inserts &nbsp; instead of space*/\n      white-space: pre!important;"),(t.tablet||t.mobile)&&s.setAttribute("x-palm-disable-auto-cap",!0),s.setAttribute("wrap","off"),s.setAttribute("autocorrect","off"),s.setAttribute("autocapitalize","off"),s.setAttribute("spellcheck",!1),s.className="lively-text-input",s.value="",i.body.insertBefore(s,e.firstChild),o.eventHandlers=[{type:"keydown",node:e,fn:function(e){return n.onRootNodeKeyDown(e)},capturing:!1},{type:"keyup",node:e,fn:function(e){return n.onRootNodeKeyUp(e)},capturing:!1},{type:"focus",node:e,fn:function(e){return n.onRootNodeFocus(e)},capturing:!0},{type:"blur",node:s,fn:function(e){return n.onTextareaBlur(e)},capturing:!0},{type:"keydown",node:s,fn:function(e){return n.onTextareaKeyDown(e)},capturing:!1},{type:"keyup",node:s,fn:function(e){return n.onTextareaKeyUp(e)},capturing:!1},{type:"cut",node:s,fn:function(e){return n.onTextareaCut(e)},capturing:!1},{type:"copy",node:s,fn:function(e){return n.onTextareaCopy(e)},capturing:!1},{type:"paste",node:s,fn:function(e){return n.onTextareaPaste(e)},capturing:!1},{type:"compositionstart",node:s,fn:function(e){return n.onCompositionStart(e)},capturing:!1},{type:"compositionend",node:s,fn:function(e){return n.onCompositionEnd(e)},capturing:!1},{type:"compositionupdate",node:s,fn:function(e){return n.onCompositionUpdate(e)},capturing:!1},{type:"input",node:s,fn:function(e){return n.onTextareaInput(e)},capturing:!1}],o.eventHandlers.forEach(function(e){var n=e.type,t=e.node,o=e.fn,i=e.capturing;return t.addEventListener(n,o,i)}),this}},{key:"uninstall",value:function(){var e=this.domState;e.isInstalled=!1,e.eventHandlers.forEach(function(e){var n=e.node,t=e.type,o=e.fn,i=e.capturing;return n.removeEventListener(t,o,i)});var n=e.textareaNode;return n&&n.parentNode&&n.parentNode.removeChild(n),e.rootNode=null,this}},{key:"resetValue",value:function(){var e=this.domState.textareaNode;e&&(e.value="")}},{key:"readValue",value:function(){var e=this.domState.textareaNode;return e?e.value.replace(j,""):""}},{key:"focus",value:function(e,n){var o=this.domState.textareaNode;o&&(o.ownerDocument.activeElement!==o&&o.focus(),t.firefox&&Promise.resolve().then(function(){return o.ownerDocument.activeElement!==o&&o.focus()}),e&&e.isText?this.ensureBeingAtCursorOfText(e):n&&this.ensureBeingInVisibleBoundsOfWorld(n))}},{key:"focusTextareaNode",value:function(e,n){return this.focus(e,n)}},{key:"focusRootNode",value:function(e,n){var t=this.domState.rootNode;t&&t.ownerDocument.activeElement!==t&&t.focus()}},{key:"blur",value:function(){var e=this.domState.textareaNode;e&&e.blur()}},{key:"doCopyWithMimeTypes",value:function(e){var n=this;return this.execCommand("manualCopy",function(){var t=n.domState.textareaNode,o=function n(o){t.removeEventListener("copy",n),o.preventDefault(),e.forEach(function(e){var n=e.data,t=e.type;return o.clipboardData.setData(t,n)})};setTimeout(function(){return t.removeEventListener("copy",o)},300),t.addEventListener("copy",o),t.value="",t.select(),t.ownerDocument.execCommand("copy")})}},{key:"doCopy",value:function(e){var n=this;return this.execCommand("manualCopy",function(){var t=n.domState.textareaNode;t.value=e,t.select(),t.ownerDocument.execCommand("copy")})}},{key:"doPaste",value:function(){var e=this;return this.execCommand("manualPaste",function(){var n=e.domState.textareaNode;n.value="",n.select(),n.ownerDocument.execCommand("paste")})}},{key:"execCommand",value:function(){function e(e,n){return t.apply(this,arguments)}var t=y(regeneratorRuntime.mark(function e(t,o){var i,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.domState.isInstalled){e.next=2;break}throw new Error("Cannot copy to clipboard – input helper is not installed into DOM!");case 2:if(i=this.inputState,!i[t]){e.next=11;break}return e.prev=4,e.next=7,i[t].promise;case 7:e.next=11;break;case 9:e.prev=9,e.t0=e.catch(4);case 11:return r=n.promise.deferred(),a=!1,i[t]={onEvent:function(e){a||(i[t]=null,a=!0,r.resolve(e))},promise:r.promise},o(),e.prev=14,e.next=17,n.promise.waitFor(1e3,function(){return a});case 17:e.next=24;break;case 19:e.prev=19,e.t1=e.catch(14),i[t]=null,a=!0,r.reject(e.t1);case 24:return e.abrupt("return",r.promise);case 25:case"end":return e.stop()}},e,this,[[4,9],[14,19]])}));return e}()},{key:"setPosition",value:function(e){var n=this.domState||{},t=n.textareaNode;t&&(t.style.left=e.x+"px",t.style.top=e.y+"px")}},{key:"ensureBeingInVisibleBoundsOfWorld",value:function(e){this.setPosition(e.visibleBounds().center())}},{key:"ensureBeingAtCursorOfText",value:function(e){if(e.world()){var n=e.textLayout.pixelPositionFor(e,e.cursorPosition),t=e.innerBounds().constrainPt(n),o=e.worldPoint(t.subPt(e.scroll));this.setPosition(o)}}},{key:"onRootNodeFocus",value:function(e){var n=this.domState||{},t=n.textareaNode,o=n.rootNode;!this.keepTextNodeFocused||e.target!==t&&e.target!==o||this.focus(),this.inputState.composition=null}},{key:"onTextareaBlur",value:function(e){var n=this;setTimeout(function(){var e=n.domState||{},t=e.rootNode;t&&document.activeElement===t&&t&&t.focus()})}},{key:"onRootNodeKeyUp",value:function(e){this.eventDispatcher.dispatchDOMEvent(e)}},{key:"onRootNodeKeyDown",value:function(e){this.eventDispatcher.dispatchDOMEvent(e)}},{key:"onTextareaKeyUp",value:function(e){this.eventDispatcher.dispatchDOMEvent(e)}},{key:"onTextareaKeyDown",value:function(e){this.eventDispatcher.dispatchDOMEvent(e)}},{key:"onTextareaInput",value:function(e){this.inputState.composition||(e.data||(e.data=this.readValue()),this.resetValue(),this.eventDispatcher.dispatchDOMEvent(e))}},{key:"onCompositionStart",value:function(e){this.inputState.composition={}}},{key:"onCompositionUpdate",value:function(e){var n=this.inputState.composition,t=this.readValue();n.lastValue!==t&&(n.lastValue=t)}},{key:"onCompositionEnd",value:function(e){this.inputState.composition=null}},{key:"onTextareaPaste",value:function(e){this.inputState.manualPaste?this.inputState.manualPaste.onEvent(e):this.eventDispatcher.dispatchDOMEvent(e)}},{key:"onTextareaCopy",value:function(e){this.inputState.manualCopy?this.inputState.manualCopy.onEvent(e):this.eventDispatcher.dispatchDOMEvent(e)}},{key:"onTextareaCut",value:function(e){this.eventDispatcher.dispatchDOMEvent(e)}}]),e}(),M={addKeyBindings:function(e){var n;this._keybindings||(this._keybindings=[]),(n=this._keybindings).unshift.apply(n,w(e))},get keybindings(){return this._keybindings||[]},set keybindings(e){return this._keybindings=e},get keyhandlers(){return[D.withBindings(this.keybindings)]},get keyCommandMap(){var e=this.keyhandlers[0].platform;return this.keybindings.reduce(function(n,t){var o=t.keys,i=f(o,e),r=t.command,a="string"==typeof r?r:r.command||r.name;return"string"!=typeof i?n:i.split("|").reduce(function(e,n){return Object.assign(e,k({},n,{name:a,command:r,prettyKeys:D.prettyCombo(n)}))},n)},{})},keysForCommand:function(e){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],t=this.keyCommandMap,o=Object.keys(t).find(function(n){return t[n].name===e});return o&&n?t[o].prettyKeys:o},simulateKeys:function(e){return D.simulateKeys(this,e)}},P=new x,z={get commands(){return this._commands||[]},set commands(e){this._commands&&this.removeCommands(this._commands),this.addCommands(e)},get commandsIncludingOwners(){return lively.lang.arr.flatmap([this].concat(this.ownerChain()),function(e){return lively.lang.arr.sortByKey(e.commands,"name").map(function(n){return{target:e,command:n}})})},addCommands:function(e){this.removeCommands(e),this._commands=(this._commands||[]).concat(e)},removeCommands:function(e){var n=e.map(function(e){return"string"==typeof e?e:e.name}),t=(this._commands||[]).filter(function(e){var t=e.name;return!n.includes(t)});t.length?this._commands=t:delete this._commands},get commandHandler(){return this._commandHandler||P},lookupCommand:function(e){var n=this.commandHandler.lookupCommand(e,this);return n&&n.command?n:null},execCommand:function(e,n,t,o){return this.commandHandler.exec(e,this,n,t,o)}};e.CommandHandler=x,e.Keys=B,e.KeyHandler=D,e.findKeysForPlatform=f,e.DOMInputCapture=N,e.KeyBindingsTrait=M,e.CommandTrait=z}(this.lively.keyboard=this.lively.keyboard||{},lively.lang,bowser),"undefined"!=typeof module&&module.exports&&(module.exports=e.lively.vm)}();